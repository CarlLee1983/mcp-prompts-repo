id: security-audit
title: Security Audit
description: |
  Authority tool for comprehensive security vulnerability assessment and security audit. TRIGGER: When user mentions "security audit", "security review", "vulnerability", "security check", "penetration test", "security scan", "owasp", or "security assessment". RULES: 1. MUST use this tool for security audit and vulnerability assessment tasks. 2. Focus on identifying security vulnerabilities and risks. 3. Check against OWASP Top 10, CWE, and other security standards. 4. Provide actionable security recommendations. 5. Prioritize vulnerabilities by severity and impact.
args:
  code:
    type: string
    description: Code to audit for security vulnerabilities (required)
    required: true
  language:
    type: string
    description: "Programming language (optional, auto-detect if not provided): php, javascript, typescript, python, go, java, csharp, ruby, etc."
    required: false
  framework:
    type: string
    description: Framework (optional, e.g., laravel, express, django, spring, react, vue)
    required: false
  focus:
    type: string
    description: "Security focus area (optional): injection, xss, csrf, auth, encryption, input_validation, or all"
    required: false
  compliance:
    type: string
    description: "Compliance standards (optional): owasp, cwe, pci_dss, gdpr, hipaa, iso27001"
    required: false
  severity_level:
    type: string
    description: "Severity level filter (optional): critical, high, medium, low, or all"
    default: all
    required: false
template: |
  {{> role-expert}}

  # Context
  You are performing a comprehensive security audit on code.
  {{#if language}}
  **Programming Language**: {{language}}
  {{/if}}
  {{#if framework}}
  **Framework**: {{framework}}
  {{/if}}
  {{#if compliance}}
  **Compliance Standards**: {{compliance}}
  {{/if}}

  # Objective
  Conduct a thorough security audit to identify:
  - Injection vulnerabilities (SQL, NoSQL, Command, LDAP, etc.)
  - Cross-Site Scripting (XSS) vulnerabilities
  - Cross-Site Request Forgery (CSRF) vulnerabilities
  - Authentication and authorization weaknesses
  - Encryption and sensitive data handling issues
  - Input validation and sanitization problems
  - Security misconfigurations
  - Insecure dependencies
  - Other security vulnerabilities

  # Style
  Provide structured security audit report with vulnerability classifications, severity ratings, and remediation recommendations.

  # Tone
  Technical, security-focused, and urgent. Prioritize critical vulnerabilities that pose immediate risks.

  # Audience
  Security engineers, developers, and security-conscious development teams.

  # Response Format

  ## Security Audit Report

  ### Code to Audit
  ```{{#if language}}{{language}}{{else}}code{{/if}}
  {{code}}
  ```

  {{#if focus}}
  ### Security Focus Area
  **Requested focus**: {{focus}}
  {{else}}
  ### Comprehensive Security Audit
  Analyzing all security aspects: injection, XSS, CSRF, authentication, encryption, and input validation.
  {{/if}}

  {{#if compliance}}
  ### Compliance Standards Check
  **Standards**: {{compliance}}
  - [Check compliance with specified standards]
  - [Identify compliance violations]
  {{/if}}

  ### Vulnerabilities Identified

  {{#if (or (eq focus "injection") (eq focus "all"))}}
  #### 1. Injection Vulnerabilities

  **SQL Injection**:
  - [Identify SQL injection vulnerabilities]
  - [List affected code sections]
  - **Severity**: [Critical/High/Medium/Low]
  - **Impact**: [Potential data breach, data loss, unauthorized access]
  - **Remediation**: [Use parameterized queries, prepared statements, ORM]

  **NoSQL Injection**:
  - [Identify NoSQL injection vulnerabilities]
  - [List affected code sections]
  - **Severity**: [Critical/High/Medium/Low]
  - **Impact**: [Potential data breach, unauthorized access]
  - **Remediation**: [Validate and sanitize input, use parameterized queries]

  **Command Injection**:
  - [Identify command injection vulnerabilities]
  - [List affected code sections]
  - **Severity**: [Critical/High]
  - **Impact**: [Remote code execution, system compromise]
  - **Remediation**: [Avoid shell execution, use safe APIs, validate input]

  **LDAP Injection**:
  - [Identify LDAP injection vulnerabilities]
  - [List affected code sections]
  - **Severity**: [High/Medium]
  - **Impact**: [Unauthorized access, information disclosure]
  - **Remediation**: [Use parameterized LDAP queries, escape special characters]

  **Example Vulnerable Code**:
  ```{{#if language}}{{language}}{{else}}code{{/if}}
  // VULNERABLE: SQL Injection
  [Vulnerable code example]
  ```

  **Example Secure Code**:
  ```{{#if language}}{{language}}{{else}}code{{/if}}
  // SECURE: Parameterized Query
  [Secure code example]
  ```
  {{/if}}

  {{#if (or (eq focus "xss") (eq focus "all"))}}
  #### 2. Cross-Site Scripting (XSS) Vulnerabilities

  **Stored XSS**:
  - [Identify stored XSS vulnerabilities]
  - [List affected code sections]
  - **Severity**: [Critical/High]
  - **Impact**: [Session hijacking, data theft, malicious script execution]
  - **Remediation**: [Output encoding, Content Security Policy (CSP)]

  **Reflected XSS**:
  - [Identify reflected XSS vulnerabilities]
  - [List affected code sections]
  - **Severity**: [High/Medium]
  - **Impact**: [Session hijacking, phishing attacks]
  - **Remediation**: [Input validation, output encoding, CSP]

  **DOM-based XSS**:
  - [Identify DOM-based XSS vulnerabilities]
  - [List affected code sections]
  - **Severity**: [High/Medium]
  - **Impact**: [Client-side script execution, session hijacking]
  - **Remediation**: [Avoid dangerous DOM manipulation, use safe APIs]

  **Example Vulnerable Code**:
  ```{{#if language}}{{language}}{{else}}code{{/if}}
  // VULNERABLE: XSS
  [Vulnerable code example]
  ```

  **Example Secure Code**:
  ```{{#if language}}{{language}}{{else}}code{{/if}}
  // SECURE: Output Encoding
  [Secure code example]
  ```
  {{/if}}

  {{#if (or (eq focus "csrf") (eq focus "all"))}}
  #### 3. Cross-Site Request Forgery (CSRF) Vulnerabilities

  **Missing CSRF Protection**:
  - [Identify endpoints without CSRF protection]
  - [List affected code sections]
  - **Severity**: [High/Medium]
  - **Impact**: [Unauthorized actions on behalf of users]
  - **Remediation**: [Implement CSRF tokens, SameSite cookies, referrer validation]

  **Weak CSRF Implementation**:
  - [Identify weak CSRF protection]
  - [List affected code sections]
  - **Severity**: [Medium]
  - **Impact**: [Potential CSRF attacks]
  - **Remediation**: [Strengthen CSRF protection mechanisms]

  **Example Secure Implementation**:
  ```{{#if language}}{{language}}{{else}}code{{/if}}
  // SECURE: CSRF Protection
  [Secure CSRF implementation]
  ```
  {{/if}}

  {{#if (or (eq focus "auth") (eq focus "all"))}}
  #### 4. Authentication and Authorization Vulnerabilities

  **Weak Authentication**:
  - [Identify weak password policies]
  - [Identify insecure session management]
  - **Severity**: [Critical/High]
  - **Impact**: [Unauthorized access, account compromise]
  - **Remediation**: [Strong password policies, secure session management, MFA]

  **Broken Authentication**:
  - [Identify authentication bypass vulnerabilities]
  - [Identify session fixation issues]
  - **Severity**: [Critical/High]
  - **Impact**: [Complete system compromise]
  - **Remediation**: [Fix authentication logic, secure session handling]

  **Insufficient Authorization**:
  - [Identify missing authorization checks]
  - [Identify privilege escalation vulnerabilities]
  - **Severity**: [Critical/High]
  - **Impact**: [Unauthorized access to resources, privilege escalation]
  - **Remediation**: [Implement proper authorization checks, role-based access control]

  **Example Vulnerable Code**:
  ```{{#if language}}{{language}}{{else}}code{{/if}}
  // VULNERABLE: Missing Authorization Check
  [Vulnerable code example]
  ```

  **Example Secure Code**:
  ```{{#if language}}{{language}}{{else}}code{{/if}}
  // SECURE: Authorization Check
  [Secure code example]
  ```
  {{/if}}

  {{#if (or (eq focus "encryption") (eq focus "all"))}}
  #### 5. Encryption and Sensitive Data Handling

  **Insecure Data Storage**:
  - [Identify plaintext storage of sensitive data]
  - [Identify weak encryption algorithms]
  - **Severity**: [Critical/High]
  - **Impact**: [Data breach, privacy violation]
  - **Remediation**: [Encrypt sensitive data, use strong encryption algorithms]

  **Weak Cryptographic Implementation**:
  - [Identify weak or deprecated cryptographic functions]
  - [Identify improper key management]
  - **Severity**: [High/Medium]
  - **Impact**: [Data decryption, security compromise]
  - **Remediation**: [Use strong cryptographic libraries, proper key management]

  **Sensitive Data Exposure**:
  - [Identify sensitive data in logs or error messages]
  - [Identify exposed API keys or credentials]
  - **Severity**: [Critical/High]
  - **Impact**: [Data breach, credential theft]
  - **Remediation**: [Remove sensitive data from logs, secure credential storage]

  **Example Secure Implementation**:
  ```{{#if language}}{{language}}{{else}}code{{/if}}
  // SECURE: Encrypted Data Storage
  [Secure encryption implementation]
  ```
  {{/if}}

  {{#if (or (eq focus "input_validation") (eq focus "all"))}}
  #### 6. Input Validation and Sanitization

  **Missing Input Validation**:
  - [Identify unvalidated user input]
  - [List affected code sections]
  - **Severity**: [High/Medium]
  - **Impact**: [Injection attacks, data corruption]
  - **Remediation**: [Implement comprehensive input validation]

  **Insufficient Input Sanitization**:
  - [Identify improperly sanitized input]
  - [List affected code sections]
  - **Severity**: [High/Medium]
  - **Impact**: [XSS, injection attacks]
  - **Remediation**: [Proper input sanitization and encoding]

  **Type Confusion**:
  - [Identify type confusion vulnerabilities]
  - [List affected code sections]
  - **Severity**: [Medium]
  - **Impact**: [Unexpected behavior, potential exploits]
  - **Remediation**: [Strict type checking, input validation]

  **Example Secure Implementation**:
  ```{{#if language}}{{language}}{{else}}code{{/if}}
  // SECURE: Input Validation
  [Secure input validation example]
  ```
  {{/if}}

  #### 7. Security Misconfigurations

  **Insecure Default Configurations**:
  - [Identify insecure default settings]
  - [List affected configurations]
  - **Severity**: [High/Medium]
  - **Impact**: [Security vulnerabilities, unauthorized access]
  - **Remediation**: [Secure default configurations, security hardening]

  **Exposed Sensitive Information**:
  - [Identify exposed debug information]
  - [Identify exposed error messages with sensitive data]
  - **Severity**: [Medium/Low]
  - **Impact**: [Information disclosure]
  - **Remediation**: [Remove debug information, sanitize error messages]

  #### 8. Insecure Dependencies

  **Vulnerable Dependencies**:
  - [Identify known vulnerabilities in dependencies]
  - [List affected packages/libraries]
  - **Severity**: [Varies based on vulnerability]
  - **Impact**: [Depends on vulnerability]
  - **Remediation**: [Update dependencies, use dependency scanning tools]

  ### Vulnerability Summary

  **Critical Vulnerabilities**: [Count]
  - [List critical vulnerabilities]

  **High Severity Vulnerabilities**: [Count]
  - [List high severity vulnerabilities]

  **Medium Severity Vulnerabilities**: [Count]
  - [List medium severity vulnerabilities]

  **Low Severity Vulnerabilities**: [Count]
  - [List low severity vulnerabilities]

  ### Remediation Priority

  #### Immediate Action Required (Critical)
  1. [Critical vulnerability 1] - [Remediation steps]
  2. [Critical vulnerability 2] - [Remediation steps]

  #### High Priority (Address Soon)
  1. [High severity vulnerability 1] - [Remediation steps]
  2. [High severity vulnerability 2] - [Remediation steps]

  #### Medium Priority (Plan for Next Release)
  1. [Medium severity vulnerability 1] - [Remediation steps]
  2. [Medium severity vulnerability 2] - [Remediation steps]

  ### Security Best Practices Checklist

  - [ ] All user input is validated and sanitized
  - [ ] Parameterized queries/prepared statements are used
  - [ ] Output encoding is implemented to prevent XSS
  - [ ] CSRF protection is implemented
  - [ ] Strong authentication mechanisms are in place
  - [ ] Proper authorization checks are implemented
  - [ ] Sensitive data is encrypted at rest and in transit
  - [ ] Secure session management is implemented
  - [ ] Error messages don't expose sensitive information
  - [ ] Dependencies are kept up-to-date
  - [ ] Security headers are properly configured
  - [ ] Logging and monitoring are implemented
  - [ ] Security testing is part of the development process

  ### OWASP Top 10 Compliance

  {{#if (or (eq compliance "owasp") (not compliance))}}
  - [ ] **A01: Broken Access Control** - [Assessment]
  - [ ] **A02: Cryptographic Failures** - [Assessment]
  - [ ] **A03: Injection** - [Assessment]
  - [ ] **A04: Insecure Design** - [Assessment]
  - [ ] **A05: Security Misconfiguration** - [Assessment]
  - [ ] **A06: Vulnerable and Outdated Components** - [Assessment]
  - [ ] **A07: Identification and Authentication Failures** - [Assessment]
  - [ ] **A08: Software and Data Integrity Failures** - [Assessment]
  - [ ] **A09: Security Logging and Monitoring Failures** - [Assessment]
  - [ ] **A10: Server-Side Request Forgery (SSRF)** - [Assessment]
  {{/if}}

  ### Additional Security Recommendations

  1. **Security Testing**: [Recommend security testing strategies]
  2. **Code Review**: [Recommend security-focused code review process]
  3. **Dependency Scanning**: [Recommend dependency scanning tools]
  4. **Penetration Testing**: [Recommend periodic penetration testing]
  5. **Security Training**: [Recommend security awareness training]

  {{output_lang_rule}}
