id: refactor-controller
title: Refactor Controller
description: |
  Authority tool for Laravel controller refactoring. TRIGGER: When user mentions "refactor controller", "improve controller", "optimize controller", or "restructure controller". RULES: 1. MUST use this tool for Laravel controller refactoring tasks. 2. Maintain existing functionality while improving code structure. 3. Apply SOLID principles and Laravel best practices. 4. Auto-infer refactoring opportunities if intent is not specified.
args:
  code:
    type: string
    description: Laravel controller code to refactor (required)
    required: true
  php_version:
    type: string
    description: "PHP version (optional, auto-detect if not provided): 8.1, 8.2, 8.3"
    required: false
  laravel_version:
    type: string
    description: "Laravel version (optional, auto-detect if not provided): 10, 11"
    required: false
  intent:
    type: string
    description: "Specific refactoring intent (optional): extract-methods, single-responsibility, dependency-injection, or auto-infer"
    required: false
  preserve_api:
    type: boolean
    description: Preserve existing API contracts and response formats
    default: true
    required: false
  apply_solid:
    type: boolean
    description: Apply SOLID principles strictly
    default: true
    required: false
template: |
  {{> role-laravel-expert}}

  # Context
  You are refactoring a Laravel controller to improve code quality, maintainability, and adherence to best practices.

  {{#if php_version}}
  **PHP Version**: {{php_version}} (explicitly specified)
  {{else}}
  **PHP Version**: Auto-detecting from code features...
  - Check for PHP 8.3 features (typed class constants, readonly classes, override attribute)
  - Check for PHP 8.2 features (readonly classes, disjunctive normal form)
  - Check for PHP 8.1 features (enums, intersection types, readonly properties)
  - Check for PHP 8.0 features (union types, match expressions, named arguments)
  {{/if}}

  {{#if laravel_version}}
  **Laravel Version**: {{laravel_version}} (explicitly specified)
  {{else}}
  **Laravel Version**: Auto-detecting from code patterns...
  - Check route definition syntax
  - Check service provider structure
  - Check model features
  - Check middleware syntax
  {{/if}}

  # Objective
  Refactor the provided controller code while:
  - Maintaining all existing functionality
  - Improving code structure and readability
  - Applying SOLID principles
  - Following Laravel {{#if laravel_version}}{{laravel_version}}{{else}}best practices{{/if}} best practices
  - Ensuring backward compatibility when preserve_api is enabled

  # Style
  Provide structured refactoring plan and refactored code with explanations.

  # Tone
  Technical, precise, and focused on improvement.

  # Audience
  Laravel developers working on the codebase.

  # Response Format

  ## Controller Refactoring Analysis

  ### Original Code
  ```php
  {{code}}
  ```

  ### Refactoring Intent
  {{#if intent}}
  **User Intent**: {{intent}}
  {{else}}
  **Auto-Inferred Intent**: Analyzing code structure to identify refactoring opportunities:
  - Method extraction needs
  - Single Responsibility Principle violations
  - Dependency injection improvements
  - Code duplication
  - Error handling patterns
  {{/if}}

  {{#if preserve_api}}
  ### ⚠️ API Preservation Mode
  All existing API contracts, response formats, and routes must remain unchanged.
  {{/if}}

  {{#if apply_solid}}
  ### SOLID Principles Application
  Applying SOLID principles:
  - **S**ingle Responsibility: Each class/method has one reason to change
  - **O**pen/Closed: Open for extension, closed for modification
  - **L**iskov Substitution: Derived classes must be substitutable
  - **I**nterface Segregation: Many specific interfaces vs one general
  - **D**ependency Inversion: Depend on abstractions, not concretions
  {{/if}}

  ### Issues Identified

  #### 1. Code Structure Issues
  - [List structural problems]
  - [Identify violations of best practices]

  #### 2. SOLID Principle Violations
  - [Identify SRP violations]
  - [Identify dependency issues]
  - [Identify other SOLID violations]

  #### 3. Laravel Best Practices
  {{#if laravel_version}}
  - [Check Laravel {{laravel_version}} conventions]
  {{else}}
  - [Check Laravel conventions (auto-detected or latest)]
  {{/if}}
  - [Identify framework misuse]
  - [Suggest Laravel-specific improvements]
  {{#if (eq php_version "8.3")}}
  - [Leverage PHP 8.3 features: typed class constants, readonly classes]
  {{/if}}
  {{#if (eq laravel_version "11")}}
  - [Leverage Laravel 11 features: streamlined structure, new exception handling]
  {{/if}}

  ### Refactoring Plan

  #### Phase 1: Method Extraction
  - [Identify methods to extract]
  - [Define new method signatures]

  #### Phase 2: Service Layer Introduction
  - [Identify business logic to move to services]
  - [Define service interfaces]

  #### Phase 3: Dependency Injection
  - [Identify dependencies to inject]
  - [Update constructor]

  #### Phase 4: Error Handling
  - [Improve exception handling]
  - [Add proper error responses]

  ### Refactored Code

  ```php
  [Provide complete refactored controller code]
  ```

  ### Key Improvements

  1. **Structure**: [Explain structural improvements]
  2. **Maintainability**: [Explain maintainability gains]
  3. **Testability**: [Explain testability improvements]
  4. **Performance**: [Explain performance optimizations if any]

  ### Migration Notes
  - [Any breaking changes or considerations]
  - [Testing recommendations]
  - [Deployment considerations]

  {{output_lang_rule}}
