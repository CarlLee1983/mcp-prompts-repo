id: laravel-error-handling
title: Laravel Error Handling Design
description: |
  Authority tool for designing comprehensive Laravel error handling patterns and exception structures. TRIGGER: When user mentions "laravel error handling", "laravel exception design", "laravel error management", "laravel error recovery", "laravel error logging", or "laravel error patterns". RULES: 1. MUST use this tool for Laravel error handling design tasks. 2. Design error handling patterns following Laravel best practices. 3. Create Laravel exception hierarchies and error response structures. 4. Include Laravel logging and monitoring strategies. 5. Provide Laravel-specific error recovery mechanisms.
args:
  code:
    type: string
    description: Existing Laravel code to analyze for error handling (optional)
    required: false
  php_version:
    type: string
    description: "PHP version (optional, auto-detect if not provided): 8.1, 8.2, 8.3"
    required: false
  laravel_version:
    type: string
    description: "Laravel version (optional, auto-detect if not provided): 10, 11"
    required: false
  error_types:
    type: string
    description: "Error types to focus on (optional): validation, business, system, network, authentication, authorization, or all"
    required: false
  include_logging:
    type: boolean
    description: Include Laravel logging strategy design
    default: true
    required: false
  include_monitoring:
    type: boolean
    description: Include monitoring and alerting design
    default: true
    required: false
  error_response_format:
    type: string
    description: "Error response format (optional): json, json-api, or custom"
    default: json
    required: false

dependencies:
  partials:
    - role-laravel-expert

template: |
  {{> role-laravel-expert}}

  # Context
  You are designing error handling patterns for Laravel code.
  {{#if php_version}}
  **PHP Version**: {{php_version}}
  {{/if}}
  {{#if laravel_version}}
  **Laravel Version**: {{laravel_version}}
  {{/if}}

  # Objective
  Design a comprehensive Laravel error handling system that:
  - Defines Laravel exception hierarchies
  - Standardizes error response formats
  - Implements proper Laravel logging
  - Provides error recovery mechanisms
  - Ensures user-friendly error messages
  - Follows Laravel {{#if laravel_version}}{{laravel_version}}{{else}}best practices{{/if}} best practices

  # Style
  Provide structured Laravel error handling design with code examples, exception hierarchies, and implementation guidelines.

  # Tone
  Technical, systematic, and focused on Laravel-specific robustness and maintainability.

  # Audience
  Laravel developers implementing error handling in their applications.

  # Response Format

  ## Laravel Error Handling Design

  {{#if code}}
  ### Existing Code Analysis
  ```php
  {{code}}
  ```

  ### Current Error Handling Assessment
  - [Analyze existing Laravel error handling patterns]
  - [Identify gaps and issues]
  - [Suggest Laravel-specific improvements]
  {{/if}}

  ### Laravel Exception Hierarchy Design

  ```php
  // Base Laravel Exception Classes
  namespace App\Exceptions;

  use Exception;
  use Illuminate\Http\JsonResponse;
  use Illuminate\Http\Request;

  /**
   * Base application exception
   */
  class ApplicationException extends Exception
  {
      public function render(Request $request): JsonResponse
      {
          return response()->json([
              'error' => [
                  'code' => $this->getCode(),
                  'message' => $this->getMessage(),
              ]
          ], $this->getStatusCode());
      }

      protected function getStatusCode(): int
      {
          return 500;
      }
  }

  // Validation Exception
  class ValidationException extends ApplicationException
  {
      protected function getStatusCode(): int
      {
          return 422;
      }
  }

  // Business Logic Exception
  class BusinessException extends ApplicationException
  {
      protected function getStatusCode(): int
      {
          return 400;
      }
  }

  // System Exception
  class SystemException extends ApplicationException
  {
      // System errors
  }
  ```

  ### Laravel Error Response Format

  **Format**: {{error_response_format}}

  #### Standard Laravel Error Response Structure

  ```json
  {
    "error": {
      "code": "ERROR_CODE",
      "message": "Human-readable error message",
      "type": "error_type",
      "details": {
        // Additional error details
      },
      "timestamp": "ISO 8601 timestamp",
      "path": "/api/endpoint",
      "request_id": "unique_request_id"
    }
  }
  ```

  ### Laravel Error Handling Patterns

  #### Pattern 1: Custom Exception Handler

  ```php
  // app/Exceptions/Handler.php
  namespace App\Exceptions;

  use Illuminate\Foundation\Exceptions\Handler as ExceptionHandler;
  use Throwable;

  class Handler extends ExceptionHandler
  {
      public function render($request, Throwable $exception)
      {
          if ($exception instanceof ApplicationException) {
              return $exception->render($request);
          }

          return parent::render($request, $exception);
      }
  }
  ```

  #### Pattern 2: Form Request Validation

  ```php
  namespace App\Http\Requests;

  use Illuminate\Foundation\Http\FormRequest;
  use Illuminate\Contracts\Validation\Validator;
  use Illuminate\Http\Exceptions\HttpResponseException;

  class CustomRequest extends FormRequest
  {
      protected function failedValidation(Validator $validator)
      {
          throw new HttpResponseException(
              response()->json([
                  'error' => [
                      'code' => 'VALIDATION_ERROR',
                      'message' => 'Validation failed',
                      'errors' => $validator->errors()
                  ]
              ], 422)
          );
      }
  }
  ```

  #### Pattern 3: API Resource Error Responses

  ```php
  namespace App\Http\Resources;

  use Illuminate\Http\Resources\Json\JsonResource;

  class ErrorResource extends JsonResource
  {
      public function toArray($request)
      {
          return [
              'error' => [
                  'code' => $this->code,
                  'message' => $this->message,
              ]
          ];
      }
  }
  ```

  {{#if include_logging}}
  ### Laravel Logging Strategy

  #### Log Channels Configuration
  ```php
  // config/logging.php
  'channels' => [
      'error' => [
          'driver' => 'daily',
          'path' => storage_path('logs/error.log'),
          'level' => 'error',
          'days' => 14,
      ],
  ],
  ```

  #### Structured Logging

  ```php
  use Illuminate\Support\Facades\Log;

  Log::error('Error occurred', [
      'error_code' => 'ERROR_CODE',
      'message' => 'Error message',
      'context' => [
          'user_id' => auth()->id(),
          'request_id' => request()->header('X-Request-ID'),
      ],
      'exception' => $exception,
  ]);
  ```

  #### Laravel Logging Best Practices
  - Use appropriate log channels
  - Include context information
  - Avoid logging sensitive information
  - Use structured logging for better searchability
  - Configure log rotation and retention
  {{/if}}

  {{#if include_monitoring}}
  ### Monitoring and Alerting

  #### Laravel Monitoring Integration
  - [Integrate with monitoring services (e.g., Sentry, Bugsnag)]
  - [Configure error tracking]
  - [Set up alerting rules]

  #### Key Metrics to Monitor
  - Error rate by type
  - Error rate by endpoint
  - Response time for error cases
  - Recovery success rate
  - System health indicators
  {{/if}}

  ### Laravel-Specific Error Handling

  #### Validation Errors
  - Use Form Requests for validation
  - Return JSON responses for API
  - Customize validation messages

  #### Authentication Errors
  - Use Laravel's authentication exceptions
  - Handle token expiration
  - Handle unauthorized access

  #### Database Errors
  - Handle query exceptions
  - Handle connection failures
  - Handle transaction failures

  ### Implementation Guidelines

  #### 1. Exception Propagation
  - Let exceptions bubble up to Laravel's exception handler
  - Transform exceptions at appropriate boundaries
  - Use Laravel's exception handling middleware

  #### 2. User-Friendly Messages
  - Provide clear, actionable error messages
  - Avoid exposing internal system details
  - Include error codes for support reference

  #### 3. Error Context
  - Include request IDs for traceability
  - Log relevant user actions and system state
  - Use Laravel's context() helper

  ### Best Practices Checklist

  - [ ] Custom exception classes are defined
  - [ ] Exception handler is configured
  - [ ] Error responses are standardized
  - [ ] All errors are logged appropriately
  - [ ] User-facing messages are clear and helpful
  - [ ] Internal errors don't expose sensitive information
  - [ ] Error recovery mechanisms are implemented
  - [ ] Monitoring and alerting are configured
  - [ ] Error handling follows Laravel {{#if laravel_version}}{{laravel_version}}{{else}}conventions{{/if}}

  {{output_lang_rule}}
